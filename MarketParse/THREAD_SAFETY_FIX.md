# ?? Thread Safety Fix - Race Condition Issue

## ????????

### ??????:
```
System.InvalidOperationException: Operations that change non-concurrent collections must have exclusive access. 
A concurrent update was performed on this collection and corrupted its state.
```

### ???????:
? `RSISimpleStrategy` ????????????? ??????? `Dictionary<string, DateTime>` ??? ???????? ??????? ????????? ???????:

```csharp
// ? ?? thread-safe
private readonly Dictionary<string, DateTime> _lastAlertTime = new();
```

### ?????? ??? ?????????

Background service ????????? RSI **?????? ???????** ??? ???? ??? **???????????**:

```csharp
var tasks = symbolsToCheck.Select(async kvp =>
{
    await _rsiStrategy.AnalyzeAsync(kvp.Key, kvp.Value);
});

await Task.WhenAll(tasks);  // ? ????????? ??????? ????????????!
```

????? ????????? ??????? ???????? ????????????:
1. ?????? ?? `_lastAlertTime` (???????? cooldown)
2. ?????? ? `_lastAlertTime` (?????????? ??????? ??????)

?????????? **race condition** ? ??????? ??????????????.

## ???????

### ? ???????????? ConcurrentDictionary

```csharp
using System.Collections.Concurrent;

// ? Thread-safe
private readonly ConcurrentDictionary<string, DateTime> _lastAlertTime = new();
```

### ???????????? ConcurrentDictionary:

1. **Thread-safe ????????:**
   - `TryGetValue()` - ?????????? ??????
   - `[key] = value` - ?????????? ??????
   - `AddOrUpdate()` - ????????? ????????

2. **??????????????????:**
   - ????????????? ??? ?????????????? ???????
   - ?????????? fine-grained locking
   - ??????????? ??????????

3. **???????? ?????????????:**
   - ?????? ????????????? ? Dictionary API
   - ?? ??????? ?????? ?????????????
   - ??? ????????????? ? `lock` ??????????

## ????????? ? ????

### ??:
```csharp
private readonly Dictionary<string, DateTime> _lastAlertTime = new();

// ????????????? race condition
if (_lastAlertTime.TryGetValue(symbol, out var lastAlert))
{
    // ...
}

_lastAlertTime[symbol] = DateTime.UtcNow;  // ? ??????!
```

### ?????:
```csharp
using System.Collections.Concurrent;

private readonly ConcurrentDictionary<string, DateTime> _lastAlertTime = new();

// Thread-safe ????????
if (_lastAlertTime.TryGetValue(symbol, out var lastAlert))
{
    // ...
}

_lastAlertTime[symbol] = DateTime.UtcNow;  // ? ?????????!
```

## ?????????????? ?????????

### 1. ??????? ??????? ??????????? RSI

**??:**
```csharp
_logger.LogInformation($"{symbol}: RSI = {rsiValue:F2}");
```

**?????:**
```csharp
_logger.LogDebug($"{symbol}: RSI = {rsiValue:F2}");
```

**???????**
- ???????? ?????????? ?????? ??????? ??? ~95 ???
- 95 ?????????/??? = 5,700 ?????????/??????
- LogDebug ?? ???????????? ?? ?????????, ????????? noise ? ?????

### 2. ?????????? ??????????? ???????

```csharp
_logger.LogInformation(
    $"? RSI alert sent for {symbol}: RSI={rsiValue:F2}, Price=${currentPrice:F4}"
);
```

?????? ? ????? ?????:
- ????? ????
- ?????? ???????? RSI
- ??????? ????

## ????????????

### ??? ????????????? ???????? (?? ???????????):

1. ????????? ?????? ? ~100 ??????
2. ????????? ????????? ?????
3. ?????? ????????? ??? ???????????? ?????????

### ???????? ???????????:

1. ????????? ??????
2. ????????? ???? - ?????? ?? ?????? ????
3. ?????????? ?????? - ?????? ?? ?????? ????

## Performance Impact

### Benchmark (????????):

| Operation | Dictionary | ConcurrentDictionary | Overhead |
|-----------|-----------|----------------------|----------|
| Read (1 thread) | ~10 ns | ~15 ns | +50% |
| Write (1 thread) | ~20 ns | ~30 ns | +50% |
| Read (10 threads) | ? Crash | ~50 ns | N/A |
| Write (10 threads) | ? Crash | ~100 ns | N/A |

**?????:** ????????? overhead ? single-threaded, ?? ???????????? ??????? ??????? ??? multi-threaded.

## ?????? ????????????? race conditions

### ? ??? ????????:

1. **_candleData ? BinanceWebSocketBackgroundService:**
   ```csharp
   lock (_lockObject)
   {
       _candleData[symbol] = candles;  // ? Protected by lock
   }
   ```

2. **_validSymbols ? _invalidSymbols:**
   ```csharp
   private readonly HashSet<string> _validSymbols = new();
   // ???????????? ?????? ? LoadHistoricalDataAsync (sequential)
   ```

### ?? ????????????? ???????? (?? ????????????):

??? - ??? ????????? ????????? ????:
- ???????????? ?????? ? ????? ??????
- ???????? lock
- Immutable ????? ?????????????

## Best Practices ??? Thread Safety

### 1. ??????????? Concurrent ?????????:
```csharp
ConcurrentDictionary<TKey, TValue>
ConcurrentBag<T>
ConcurrentQueue<T>
ConcurrentStack<T>
```

### 2. ??? ??????????? lock:
```csharp
private readonly object _lock = new();
private readonly Dictionary<string, DateTime> _data = new();

public void Update(string key, DateTime value)
{
    lock (_lock)
    {
        _data[key] = value;
    }
}
```

### 3. ?????????:
```csharp
// ? ?? ??????? ??? ? multi-threaded ????!
if (!_dict.ContainsKey(key))
{
    _dict[key] = value;  // Race condition!
}

// ? ??????????? TryAdd ?????? ?????:
_concurrentDict.TryAdd(key, value);
```

## Monitoring

????? ??????????? ????????? ???? ??:

### ? ?????? ????:
```
? RSI alert sent for BTCUSDT: RSI=68.45, Price=$45123.50
?? Service status: Monitoring 95 pairs
```

### ? ?? ?????? ????:
```
System.InvalidOperationException
concurrent collections must have exclusive access
corrupted its state
```

## ??????????

- ? **????????:** Race condition ? Dictionary
- ? **???????:** ConcurrentDictionary
- ? **?????????:** Thread-safe ????????
- ? **Overhead:** ??????????? (~50% ?? single-thread, ?? ?????????)
- ? **????????????:** ?????????????

---

**Status:** ? FIXED  
**Version:** 1.1  
**Date:** 2025-01-08
